{"version":3,"file":"stores.js","sourceRoot":"","sources":["../ts/stores.ts"],"names":[],"mappings":"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","sourcesContent":["import { useComputed, useSignal } from '@preact/signals'\nimport { Wallet } from 'ethers'\nimport { MEV_RELAY_MAINNET } from './constants.js'\nimport { getMaxBaseFeeInFutureBlock } from './library/bundleUtils.js'\nimport { EthereumAddress } from './types/ethereumTypes.js'\nimport { ProviderStore } from './library/provider.js'\nimport { AppSettings, BlockInfo, Bundle, Signers } from './types/types.js'\nimport { TransactionList } from './types/bouquetTypes.js'\nimport { addressString } from './library/utils.js'\n\nfunction fetchBurnerWalletFromStorage(): Wallet {\n\tconst burnerPrivateKey = localStorage.getItem('wallet')\n\ttry {\n\t\treturn burnerPrivateKey ? new Wallet(burnerPrivateKey) : new Wallet(Wallet.createRandom().privateKey)\n\t} catch {\n\t\treturn new Wallet(Wallet.createRandom().privateKey)\n\t}\n}\n\nfunction fetchBundleFromStorage(): Bundle | undefined {\n\tconst payload = JSON.parse(localStorage.getItem('payload') ?? 'null')\n\tif (!payload) return undefined\n\tconst tryParse = TransactionList.safeParse(payload)\n\tif (!tryParse.success) {\n\t\tlocalStorage.removeItem('payload')\n\t\treturn undefined\n\t}\n\tconst parsed = tryParse.value\n\n\tconst uniqueToAddresses = [...new Set(parsed.map(({ from }) => from))]\n\tconst containsFundingTx = uniqueToAddresses.includes('FUNDING')\n\tconst uniqueSigners = uniqueToAddresses.filter((address): address is EthereumAddress => address !== 'FUNDING').map(address => addressString(address))\n\n\tconst totalGas = parsed.reduce((sum, tx) => tx.gasLimit + sum, 0n)\n\tconst inputValue = parsed.reduce((sum, tx) => tx.from === 'FUNDING' ? tx.value + sum : sum, 0n)\n\n\treturn { transactions: parsed, containsFundingTx, uniqueSigners, totalGas, inputValue }\n}\n\nfunction fetchSettingsFromStorage() {\n\tconst defaultValues: AppSettings = { blocksInFuture: 3n, priorityFee: 10n ** 9n * 3n, relayEndpoint: MEV_RELAY_MAINNET };\n\tconst custom = localStorage.getItem('bouquetSettings')\n\tif (!custom) {\n\t\treturn defaultValues\n\t} else {\n\t\ttry {\n\t\t\tconst parsed = JSON.parse(custom)\n\t\t\tif ('relayEndpoint' in parsed) defaultValues.relayEndpoint = parsed.relayEndpoint\n\t\t\tif ('priorityFee' in parsed) defaultValues.priorityFee = BigInt(parsed.priorityFee)\n\t\t\tif ('blocksInFuture' in parsed) defaultValues.blocksInFuture = BigInt(parsed.blocksInFuture)\n\t\t\treturn defaultValues\n\t\t} catch {\n\t\t\treturn defaultValues\n\t\t}\n\t}\n}\n\nexport function createGlobalState() {\n\tconst appSettings = useSignal<AppSettings>(fetchSettingsFromStorage())\n\tconst provider = useSignal<ProviderStore | undefined>(undefined)\n\tconst blockInfo = useSignal<BlockInfo>({ blockNumber: 0n, baseFee: 0n, priorityFee: 10n ** 9n * 3n })\n\tconst signers = useSignal<Signers>({ burner: fetchBurnerWalletFromStorage(), burnerBalance: 0n, bundleSigners: {} })\n\tconst bundle = useSignal<Bundle | undefined>(fetchBundleFromStorage())\n\n\t// Sync burnerWallet to localStorage\n\tsigners.subscribe(({ burner }) => {\n\t\tif (burner) localStorage.setItem('wallet', burner.privateKey)\n\t\telse localStorage.removeItem('wallet')\n\t})\n\n\tconst fundingAmountMin = useComputed(() => {\n\t\tif (!bundle.value) return 0n\n\t\tif (!bundle.value.containsFundingTx) return 0n\n\t\tconst maxBaseFee = getMaxBaseFeeInFutureBlock(blockInfo.value.baseFee, appSettings.value.blocksInFuture)\n\t\treturn bundle.value.totalGas * (blockInfo.value.priorityFee + maxBaseFee) + bundle.value.inputValue\n\t})\n\n\treturn { provider, blockInfo, bundle, appSettings, signers, fundingAmountMin }\n}\n"]}